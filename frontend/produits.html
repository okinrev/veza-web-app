<!-- file: frontend/produits.html -->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Produits Talas</title>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8 font-sans text-gray-800" x-data="produitsApp()" x-init="chargerProduits()">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-center">üéõÔ∏è Produits enregistr√©s</h1>

    <!-- üí¨ Message -->
    <template x-if="message">
      <div class="mb-4 p-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded" x-text="message"></div>
    </template>

    <!-- ‚ûï Formulaire -->
    <form @submit.prevent="enregistrerProduit" class="bg-white shadow p-6 rounded-lg mb-8 space-y-4">
      <h2 class="text-xl font-semibold" x-text="form.id ? 'Modifier le produit' : 'Ajouter un produit'"></h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input type="text" placeholder="Nom" x-model="form.name" required class="border p-2 rounded w-full" />
        <input type="text" placeholder="Version" x-model="form.version" required class="border p-2 rounded w-full" />
        <input type="date" x-model="form.purchase_date" required class="border p-2 rounded w-full" />
        <input type="date" x-model="form.warranty_expires" required class="border p-2 rounded w-full" />
      </div>

      <div class="flex items-center space-x-4 mt-4">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Enregistrer
        </button>
        <button type="button" @click="resetForm()" x-show="form.id" class="text-sm text-gray-600 underline">
          Annuler
        </button>
      </div>
    </form>

    <!-- üìã Liste des produits -->
    <div class="bg-white shadow overflow-hidden rounded-lg">
      <table class="min-w-full table-auto text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left font-semibold">Nom</th>
            <th class="px-4 py-2 text-left font-semibold">Version</th>
            <th class="px-4 py-2 text-left font-semibold">Achat</th>
            <th class="px-4 py-2 text-left font-semibold">Fin garantie</th>
            <th class="px-4 py-2 text-left font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="p in produits" :key="p.id">
            <tr class="border-b hover:bg-gray-50">
              <td class="px-4 py-2" x-text="p.name"></td>
              <td class="px-4 py-2" x-text="p.version"></td>
              <td class="px-4 py-2" x-text="formatDate(p.purchase_date)"></td>
              <td class="px-4 py-2" x-text="formatDate(p.warranty_expires)"></td>
              <td class="px-4 py-2">
                <button @click="remplirFormulaire(p)" class="text-blue-600 hover:underline mr-2">‚úèÔ∏è</button>
                <button @click="supprimerProduit(p.id)" class="text-red-600 hover:underline">üóëÔ∏è</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <script src="js/produits.js">
    // file: frontend/js/produits.js

    function produitsApp() {
        return {
          produits: [],
          message: '',
          form: {
            id: null,
            name: '',
            version: '',
            purchase_date: '',
            warranty_expires: ''
          },

          async getValidToken() {
            return localStorage.getItem('access_token') || null
          },

          async chargerProduits() {
            const token = await this.getValidToken()
            if (!token) return this.message = "Non connect√©"

            try {
              const r = await fetch('/products', {
                headers: { 'Authorization': 'Bearer ' + token }
              })
              if (!r.ok) throw new Error("Erreur " + r.status)
              this.produits = await r.json()
            } catch (e) {
              this.message = e.message
            }
          },

          formatDate(str) {
            const d = new Date(str)
            return isNaN(d) ? '‚Äî' : d.toLocaleDateString('fr-FR')
          },

          remplirFormulaire(p) {
            this.form = { ...p }
            this.form.purchase_date = p.purchase_date.split('T')[0]
            this.form.warranty_expires = p.warranty_expires.split('T')[0]
          },

          resetForm() {
            this.form = {
              id: null,
              name: '',
              version: '',
              purchase_date: '',
              warranty_expires: ''
            }
          },

          async enregistrerProduit() {
            const token = await this.getValidToken()
            if (!token) return this.message = "Non connect√©"

            const method = this.form.id ? 'PUT' : 'POST'
            const url = this.form.id ? `/products/${this.form.id}` : '/products'

            const payload = {
              name: this.form.name,
              version: this.form.version,
              purchase_date: new Date(this.form.purchase_date).toISOString(),
              warranty_expires: new Date(this.form.warranty_expires).toISOString()
            }

            try {
              const r = await fetch(url, {
                method,
                headers: {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              })

              if (!r.ok) throw new Error("Erreur " + r.status)
              this.message = this.form.id ? "‚úÖ Produit mis √† jour" : "‚úÖ Produit cr√©√©"
              this.resetForm()
              this.chargerProduits()
            } catch (e) {
              this.message = e.message
            }
          },

          async supprimerProduit(id) {
            const token = await this.getValidToken()
            if (!token) return this.message = "Non connect√©"

            try {
              const r = await fetch(`/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
              })
              if (!r.ok) throw new Error("Erreur " + r.status)
              this.message = "üóëÔ∏è Produit supprim√©"
              this.chargerProduits()
            } catch (e) {
              this.message = e.message
            }
          }
        }
      }
  </script>
</body>
</html>
