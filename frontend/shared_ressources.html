<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ressources partagÃ©es â€” Talas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 font-sans bg-gray-100">
  <div class="max-w-3xl mx-auto bg-white shadow p-6 rounded space-y-4">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ Ressources partagÃ©es</h1>

    <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
      <input type="text" name="title" placeholder="Titre de la ressource" required class="w-full border p-2 rounded" />
      <select name="type" required class="w-full border p-2 rounded">
        <option value="">-- SÃ©lectionner un type --</option>
        <option value="sample">ğŸµ Sample</option>
        <option value="preset">ğŸ›ï¸ Preset</option>
        <option value="project">ğŸ“ Projet</option>
        <option value="mix">ğŸšï¸ Mix</option>
        <option value="stem">ğŸ™ï¸ Stem</option>
      </select>      
      <input type="file" name="file" required class="w-full border p-2 rounded" />
      <input type="text" name="tags" id="tagInput" placeholder="Tags (ex: hiphop, ambient)" class="w-full border p-2 rounded" list="tagSuggestions" />
      <datalist id="tagSuggestions"></datalist>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Partager</button>
    </form>

    <pre id="result" class="bg-gray-50 border p-2 text-sm mt-4 overflow-x-auto"></pre>

    <form id="searchForm" class="flex gap-4 mb-4">
      <input type="text" id="searchTag" placeholder="Tag" class="border p-2 rounded w-1/3" />
      <input type="text" id="searchType" placeholder="Type (sample...)" class="border p-2 rounded w-1/3" />
      <input type="text" id="searchTitle" placeholder="Titre" class="border p-2 rounded w-1/3" />
      <button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded">ğŸ” Rechercher</button>
    </form>    

    <h2 class="text-xl font-semibold mt-6">ğŸ“š Fichiers disponibles</h2>
    <div id="ressourceList" class="space-y-4 mt-2"></div>
  </div>

  <script>
    const result = document.getElementById('result');
    const ressourceList = document.getElementById('ressourceList');

    async function getValidToken() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        result.textContent = "âŒ Token dâ€™authentification manquant.";
        throw new Error("Token manquant");
      }
      return token;
    }

    async function loadRessources() {
      try {
        const token = await getValidToken();
        const res = await fetch('/shared_ressources', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          result.textContent = "âŒ Erreur chargement (" + res.status + ")";
          return;
        }

        const ressources = await res.json();
        ressourceList.innerHTML = '';

        ressources.forEach(ressource => {
          const item = document.createElement('div');
          item.className = "border p-3 rounded bg-gray-50";

          item.innerHTML = `
            <div class="font-semibold">${ressource.title}</div>
            <div class="text-sm text-gray-600">${ressource.type} â€” ${ressource.filename}</div>
            <div class="flex gap-4 mt-2">
              <a href="/shared_ressources/${encodeURIComponent(ressource.filename)}" target="_blank" class="text-blue-600 hover:underline">
                ğŸ‘ï¸ Visualiser
              </a>
              <a href="/shared_ressources/${encodeURIComponent(ressource.filename)}" download class="text-green-600 hover:underline">
                â¬‡ï¸ TÃ©lÃ©charger
              </a>
            </div>
          `;

          ressourceList.appendChild(item);
        });
      } catch (err) {
        console.error("Erreur loadRessources :", err);
      }
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      try {
        const token = await getValidToken();
        const res = await fetch('/shared_ressources', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token
          },
          body: formData
        });

        if (res.ok) {
          const data = await res.json();
          result.textContent = "âœ… Ressource partagÃ©e : " + data.title;
          form.reset();
          await loadRessources();
        } else {
          result.textContent = "âŒ Erreur : " + res.status + " â€” " + await res.text();
        }
      } catch (err) {
        console.error("Erreur upload:", err);
      }
    });

    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const tag = document.getElementById('searchTag').value;
      const type = document.getElementById('searchType').value;
      const title = document.getElementById('searchTitle').value;

      try {
        const res = await fetch(`/shared_ressources/search?tag=${encodeURIComponent(tag)}&type=${encodeURIComponent(type)}&title=${encodeURIComponent(title)}`, {
          headers: { 'Authorization': 'Bearer ' + await getValidToken() }
        });

        if (!res.ok) {
          result.textContent = "âŒ Erreur recherche : " + res.status;
          return;
        }

        const ressources = await res.json();
        ressourceList.innerHTML = '';

        ressources.forEach(ressource => {
          const item = document.createElement('div');
          item.className = "border p-3 rounded bg-gray-50";

          item.innerHTML = `
            <div class="font-semibold">${ressource.title}</div>
            <div class="text-sm text-gray-600">${ressource.type} â€” ${ressource.filename}</div>
            <div class="flex gap-4 mt-2">
              <a href="/shared_ressources/${encodeURIComponent(ressource.filename)}" target="_blank" class="text-blue-600 hover:underline">
                ğŸ‘ï¸ Visualiser
              </a>
              <a href="/shared_ressources/${encodeURIComponent(ressource.filename)}?download=true" download class="text-green-600 hover:underline">
                â¬‡ï¸ TÃ©lÃ©charger
              </a>
            </div>
          `;

          ressourceList.appendChild(item);
        });
      } catch (err) {
        console.error("âŒ Erreur JS recherche :", err);
      }
    });

    const predefinedTags = [
      "hiphop", "trap", "ambient", "drum", "bass", "techno", "house",
      "lofi", "synth", "vocal", "fx", "kick", "808", "snare", "melodic"
    ];

    function updateTagSuggestions() {
      const datalist = document.getElementById('tagSuggestions');
      datalist.innerHTML = '';
      predefinedTags.forEach(tag => {
        const opt = document.createElement('option');
        opt.value = tag;
        datalist.appendChild(opt);
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateTagSuggestions();
      loadRessources();
    });

  </script>
</body>
</html>
